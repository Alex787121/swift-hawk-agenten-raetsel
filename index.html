<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Swift & Hawk — Agentenrätsel</title>
  <style>
    :root{ --bg: #071022; --card: #0f2433; --accent: #12b3ff; --muted: #9fb6c8; }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:linear-gradient(180deg,#02101a,#071022);color:#e8f6fb;padding:18px}
    .container{max-width:980px;margin:0 auto}
    .header{display:flex;gap:12px;align-items:center;margin-bottom:14px}
    .logo{width:64px;height:64px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#7be3ff);display:flex;align-items:center;justify-content:center;color:#04202c;font-weight:900}
    .card{background:var(--card);padding:14px;border-radius:12px;margin-bottom:12px;box-shadow:0 10px 30px rgba(0,0,0,0.45)}
    h1,h2{margin:0 0 8px 0}
    .small{color:var(--muted);font-size:13px}
    .progress{display:flex;gap:8px;margin-bottom:10px}
    .dot{width:12px;height:12px;border-radius:99px;background:rgba(255,255,255,0.05)}
    .dot.done{background:#33d08a}
    .mission{display:none;padding:12px;border-radius:8px;background:rgba(255,255,255,0.02);margin-bottom:10px}
    input[type=text]{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit}
    button{padding:8px 12px;border-radius:8px;border:0;background:var(--accent);color:#04202c;font-weight:700;cursor:pointer}
    .center{text-align:center}
    #timer{font-weight:700;color:#9ff5c7}
    .leaderboard-row{display:grid;grid-template-columns:1fr 80px 150px;gap:8px;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.02)}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">S&H</div>
      <div>
        <h1>Swift & Hawk — Agentenrätsel (10 Missionen)</h1>
        <div class="small">Niveau: 8. Klasse — Missionen schalten sich nacheinander frei. Name wird gespeichert. Online-Bestenliste via Firebase optional.</div>
      </div>
    </div>

    <div class="card" id="loginCard">
      <h2>Agenten-Login</h2>
      <p class="small">Gib deinen Codenamen ein (wird im Browser gespeichert):</p>
      <input id="agentName" type="text" placeholder="AgentAlex" />
      <div style="margin-top:8px">
        <label><input id="useFirebase" type="checkbox" /> Aktiv: Online-Bestenliste (Firebase, optional)</label>
      </div>
      <div style="margin-top:10px;display:flex;gap:8px">
        <button onclick="startRun()">Start Missionen</button>
        <button style="background:#e06f6f" onclick="clearName()">Name löschen</button>
      </div>
      <p class="small" style="margin-top:8px">Hinweis: Falls Firebase nicht konfiguriert ist, funktioniert die Seite komplett lokal (Bestenliste lokal).</p>
    </div>

    <div class="card" id="gameCard" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div><strong id="greet">Agent</strong></div>
        <div class="small">Zeit: <span id="timer">00:00</span></div>
      </div>
      <div class="progress" id="dots"></div>
      <div id="missions"></div>
      <div style="margin-top:12px" class="center">
        <button id="finishBtn" style="display:none" onclick="finishRun()">Alle Missionen geschafft — Ergebnis speichern</button>
      </div>
    </div>

    <div class="card">
      <h2>Bestenliste</h2>
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
        <button onclick="loadLeaderboard()">Aktualisieren</button>
        <div class="small">Zeigt Name + Zeit (mm:ss). Online- und lokale Liste kombiniert.</div>
      </div>
      <div id="leaderboard"></div>
    </div>

    <div class="card small">
      <strong>Assets & Datenschutz</strong>
      <ul>
        <li>Audio- und Bilddateien sind Platzhalter — du kannst eigene Dateien in assets/ ersetzen.</li>
        <li>Bei aktivierter Online-Bestenliste werden nur Name + Zeit + Datum gespeichert (Firestore).</li>
      </ul>
    </div>
  </div>

  <!-- Sounds (platzhalter) -->
  <audio id="sound-ok" src="assets/ok.wav"></audio>
  <audio id="sound-wrong" src="assets/wrong.wav"></audio>
  <audio id="sound-complete" src="assets/complete.wav"></audio>

  <script>
  // --- MISSIONEN (10, Niveau 8. Klasse) ---
  const missions = [
    {id:1,title:'Caesar-Chiffre', prompt:"Entschlüssele: 'Mjqqt' (Verschiebung +5)", hint:'Verschiebung +5', check: a => a === 'hello'},
    {id:2,title:'Zahlenfolge', prompt:'Welche Zahl kommt als nächstes? 2,4,8,16, ?', hint:'Verdoppelt', check: a => a === '32'},
    {id:3,title:'Akrostichon', prompt:"Erste Buchstaben: 'Sicherheit Handelt Immer Nach Prinzipien' → Wort?", hint:'Erste Buchstaben', check: a => a === 'shin'},
    {id:4,title:'Binär zu Text', prompt:'Binär: 01100011 01101111 01100100 01100101', hint:'ASCII', check: a => a === 'code'},
    {id:5,title:'Anagramm', prompt:"Aus 'TISFW' ein englisches Wort bilden", hint:'englisches Wort', check: a => a === 'swift'},
    {id:6,title:'Flächeninhalt', prompt:'Rechteck Seiten 7 und 5 — Fläche?', hint:'Länge × Breite', check: a => a === '35'},
    {id:7,title:'Silbenrätsel', prompt:'flink + Raubvogel = ? (zwei Silben zusammen)', hint:'Buchtitel denken', check: a => a === 'swift'},
    {id:8,title:'Rätsel', prompt:'Ich habe Schlüssel, aber keine Tür. Was bin ich?', hint:'Sichert Infos', check: a => a === 'code'},
    {id:9,title:'Morse', prompt:"Morse: '... --- ...' → Was bedeutet das?", hint:'Rettungsruf', check: a => a === 'sos'},
    {id:10,title:'Final', prompt:'Setze die Codewörter 1–4 zusammen (mit Leerzeichen)', hint:'Wort1 Wort2 Wort3 Wort4', check: a => a === 'hello 32 shin code'}
  ];

  // runtime state
  let agent = '';
  let current = 0;
  let startTime = 0;
  let timerInterval = null;
  let points = 0;

  // helpers
  function el(id){ return document.getElementById(id); }
  function secToStr(sec){
    const mm = Math.floor(sec/60);
    const ss = sec % 60;
    return String(mm).padStart(2,'0') + ':' + String(ss).padStart(2,'0');
  }
  function playSound(id){
    try{ const s = el('sound-' + id); if(s){ s.currentTime = 0; s.play(); } } catch(e){}
  }

  // render missions UI
  function renderMissions(){
    const container = el('missions');
    container.innerHTML = '';
    missions.forEach((m, idx) => {
      const div = document.createElement('div');
      div.className = 'mission';
      div.id = 'mission-' + m.id;
      div.innerHTML = `<h3>Mission ${m.id} — ${m.title}</h3>
        <div class="small">${m.prompt}</div>
        <div class="small" style="margin-top:6px">${m.hint}</div>
        <input type="text" id="input-${m.id}" placeholder="Antwort eingeben" />
        <div style="margin-top:8px"><button onclick="tryMission(${m.id})">Prüfen</button></div>
        <div id="res-${m.id}" class="small" style="margin-top:6px"></div>`;
      container.appendChild(div);
    });

    // dots
    const dots = el('dots') || (function(){ const d = document.createElement('div'); d.id = 'dots'; el('gameCard').insertBefore(d, el('missions')); return d; })();
    dots.innerHTML = '';
    for(let i=0;i<missions.length;i++){
      const dot = document.createElement('div'); dot.className = 'dot'; dot.id = 'dot-'+(i+1); dots.appendChild(dot);
    }
    updateUI();
  }

  function updateUI(){
    missions.forEach((m, idx) => {
      const node = el('mission-' + m.id);
      if(!node) return;
      if(idx <= current - 1) node.style.display = 'block'; else node.style.display = 'none';
      const dot = el('dot-' + (idx+1));
      if(dot) {
        if(idx < current - 1) dot.classList.add('done'); else dot.classList.remove('done');
      }
    });
    // finish button
    if(current > missions.length) el('finishBtn').style.display = 'inline-block'; else el('finishBtn').style.display = 'none';
  }

  // timer
  function startTimer(){
    startTime = Date.now();
    timerInterval = setInterval(() => {
      const diff = Math.floor((Date.now() - startTime) / 1000);
      el('timer').innerText = secToStr(diff);
    }, 250);
  }
  function stopTimer(){
    if(timerInterval) { clearInterval(timerInterval); timerInterval = null; }
  }

  // name storage
  function saveNameLocal(n){ localStorage.setItem('agentName', n); }
  function clearName(){
    localStorage.removeItem('agentName');
    alert('Name gelöscht.');
    location.reload();
  }

  function startRun(){
    const n = (el('agentName').value || '').trim();
    if(!n) { alert('Bitte Codenamen eingeben'); return; }
    agent = n;
    saveNameLocal(agent);
    el('greet').innerText = 'Agent ' + agent;
    el('loginCard').style.display = 'none';
    el('gameCard').style.display = 'block';
    renderMissions();
    current = 1;
    showMission(current);
    startTimer();
  }

  function showMission(id){
    missions.forEach(m => {
      const node = el('mission-' + m.id);
      if(node) node.style.display = (m.id === id) ? 'block' : 'none';
    });
    // update dots
    for(let i=1;i<=missions.length;i++){
      const dot = el('dot-'+i);
      if(dot){
        if(i < id) dot.classList.add('done'); else dot.classList.remove('done');
      }
    }
  }

  function tryMission(id){
    const m = missions.find(x => x.id === id);
    if(!m) return;
    const raw = (el('input-' + id).value || '').toString().trim().toLowerCase();
    // normalize answers: remove punctuation, collapse spaces
    const user = raw.replace(/[^a-z0-9\s]/g,'').replace(/\s+/g,' ').trim();
    const res = el('res-' + id);
    if(m.check(user)){
      playSound('ok');
      points += 10;
      res.innerHTML = '<span style="color:#33d08a">✓ Richtig</span>';
      // advance
      if(id < missions.length){
        current = id + 1;
        showMission(current);
      } else {
        current = missions.length + 1;
        finishRun();
      }
    } else {
      playSound('wrong');
      res.innerHTML = '<span style="color:#ff9b9b">Falsch — nochmal prüfen.</span>';
    }
    updateUI();
  }

  // finish
  async function finishRun(){
    stopTimer();
    playSound('complete');
    const timeText = el('timer').innerText || '00:00';
    const parts = timeText.split(':'); const seconds = (parseInt(parts[0]||0) * 60) + (parseInt(parts[1]||0));
    const payload = { name: agent, time: seconds, timeText: timeText, points: points, date: new Date().toISOString() };
    // online or local
    try{
      if(window.firebaseConfig && el('useFirebase').checked && typeof submitScoreOnline === 'function'){
        await submitScoreOnline(payload);
        alert('Ergebnis online gespeichert.');
      } else {
        saveLocalScore(payload);
        alert('Ergebnis lokal gespeichert.');
      }
    } catch(e){
      console.error(e);
      saveLocalScore(payload);
      alert('Fehler beim Online-Speichern — Ergebnis lokal gespeichert.');
    }
    loadLeaderboard();
  }

  // local leaderboard save/load
  function saveLocalScore(payload){
    const key = 'sh_scores';
    const arr = JSON.parse(localStorage.getItem(key) || '[]');
    arr.push(payload);
    arr.sort((a,b) => {
      if(a.time !== b.time) return a.time - b.time;
      return (b.points || 0) - (a.points || 0);
    });
    localStorage.setItem(key, JSON.stringify(arr.slice(0,100)));
  }

  async function loadLeaderboard(){
    const container = el('leaderboard');
    container.innerHTML = '';
    let online = [];
    if(window.firebaseConfig && el('useFirebase').checked && typeof fetchOnlineScores === 'function'){
      try{ online = await fetchOnlineScores(); } catch(e){ console.warn('Online-LB nicht verfügbar', e); }
    }
    const local = JSON.parse(localStorage.getItem('sh_scores') || '[]');
    const merged = (online.concat(local)).slice(0,200);
    merged.sort((a,b) => {
      if(a.time !== b.time) return a.time - b.time;
      return (b.points || 0) - (a.points || 0);
    });
    const top = merged.slice(0,20);
    if(top.length === 0){ container.innerHTML = '<div class="small">Noch keine Ergebnisse.</div>'; return; }
    const head = document.createElement('div'); head.className = 'leaderboard-row'; head.innerHTML = '<div style="font-weight:700">Name</div><div class="center" style="font-weight:700">Zeit</div><div class="center" style="font-weight:700">Datum</div>';
    container.appendChild(head);
    top.forEach((s, i) => {
      const row = document.createElement('div'); row.className = 'leaderboard-row';
      const dateStr = s.date ? (new Date(s.date)).toLocaleString() : '';
      row.innerHTML = `<div>${i+1}. ${escapeHtml(s.name || 'unbekannt')}</div><div class="center">${s.timeText || secToStr(s.time || 0)}</div><div class="center small">${dateStr}</div>`;
      container.appendChild(row);
    });
  }

  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  // Firebase helpers (optional) - implement when firebase-config.js provides window.firebaseConfig
  async function submitScoreOnline(payload){
    if(!window.firebase) throw new Error('Firebase SDK nicht geladen');
    const db = firebase.firestore();
    await db.collection('scores').add(payload);
  }
  async function fetchOnlineScores(){
    if(!window.firebase) throw new Error('Firebase SDK nicht geladen');
    const db = firebase.firestore();
    const snap = await db.collection('scores').orderBy('time','asc').limit(100).get();
    const out = []; snap.forEach(doc => out.push(doc.data())); return out;
  }

  // Auto-load firebase SDK if config is present
  (function initFirebaseIfConfigured(){
    if(window.firebaseConfig){
      const s1 = document.createElement('script'); s1.src = 'https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js'; document.head.appendChild(s1);
      const s2 = document.createElement('script'); s2.src = 'https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js'; document.head.appendChild(s2);
      s2.onload = () => { try{ firebase.initializeApp(window.firebaseConfig); console.log('Firebase initialisiert'); } catch(e){ console.error(e); } };
    }
  })();

  // restore name on load and render preview missions
  window.addEventListener('load', () => {
    const n = localStorage.getItem('agentName'); if(n) el('agentName').value = n;
    renderMissions();
    loadLeaderboard();
  });

  </script>
</body>
</html>
